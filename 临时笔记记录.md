---
title: 临时笔记记录
tags: 
created: 2024-02-05
modified: 2024-03-06
---

## 1. 背景
openelb 0.5.1 版本的控制面和数据面集成在 openelb-manager 中，为满足建行的数据面和控制面分离的需求，需要将 openelb 拆分为 openelb-manager(deploy) 和 openelb-speaker(ds)

功能划分如下：

| 组件 | 功能 | 其他说明 |
| ---- | ---- | ---- |
| openelb-controller | ipam | 容器网络 |
| openelb-speaker | 路由宣告 | 主机网络 |
## 2. openelb-controller 功能点：
### 当前版本需要支持的功能(基本功能)：
- openelb-controller deploy 支持多副本
- ipam
	- 处理 eip 并为 svc 分配 ip，记录 ip-svc 关系
	- 支持默认 eip

### enhance 功能：
- svc 指定注解的数量 - 去除重复意义的 openelb 注解，但同时需要注意兼容性
- webhook 的完善
	- 验证 eip (采用 webhookbuilder)
	- 对于默认 eip 支持，webhook 修改创建的 service(采用 manager.webhookServer)

> ps: 默认 eip 支持的技术实现为：使用 webhook 拦截 service 的创建事件，并将相应的 openelb 的注解添加到 service 的annotation 列表中，由未指定 eip + protocol 变为指定 eip + protocol 分配。

### feature 开发：
1. eip 绑定 namespace - *(删除默认 eip 的支持)*
ipam 分配原理发生变化，由之前的指定 openelb + eip + protocol 的手动指定分配方式变更为以下两种：
- 自动分配:
	- 根据匹配的 namespace 按照特定的算法(轮询、顺序即IP占满后选下一个)来分配，不在意选定 eip 的协议 - **待定**
	- 指定 protocol 分配的自动分配
- 手动指定分配：
	- 手动指定 eip 分配
	- 手动指定 ip 分配

2. 双栈的支持
3. loadBalancerClass 字段支持 - 判断是否指定为 openelb
4. allocateLoadBalancerNodePorts -  调研是否支持

### 待定：
- 未开启某一个协议的 speaker，无法创建该协议的 eip

### 其余问题：
- loadBalancerIP - Kubernetes v1.24 中被弃用，保留现有的逻辑
- cni 兼容 - 暂时对 controller 没有影响
- openelb 在启动时处理所有的 svc

## 3. openelb-speaker 功能点：
### 当前版本需要支持的功能(基本功能)：
1. layer2 speaker：
- 支持故障转移、自感知节点加入、退出
- 将 svcip 分布到不同的节点、发布 GARP、回应 arp 请求
- 检测 eip 配置网卡信息

2. bgp speaker：
- bgp 处理 bgpcong、bgppeer 
- 考虑与其他 bgp cni 兼容 [参考 metallb](https://metallb.org/installation/network-addons/)
	不部署 speaker? 添加 label openelb.kubesphere.io/cni: calico，但是还存在一定问题
- 正常建立 bgp peer 并发布路由
- gobgp policy

3. vip speaker：
- 分配 svcip 后填充 configmap
- 将 svcip 注册到网卡
- 故障转移

### enhance 功能：
1. 多个 speaker 的启动配置
- 是否启用
- 是否允许多个 speaker 同时存在

2. vip 卸载
- vip 卸载 keepalived-vip ds 依旧存在

### feature 开发：
1. layer2 模式：
- 多网卡问题 -  通过 node lable 指定后 arping 不通
- eip 过滤节点
- layer2 宣告策略
- 记录 node-svcip 的记录

2. vip 模式：
- 多网卡情况下绑定网卡
- 绑定 vip-master 节点(待调研)
- 配置多个 vrrp instance

3. 支持 endpointslice
- svc externalTrafficPolicy local/cluster
- layer2 获取 node 列表

### 其余问题：
layer2 模式的单点故障解决方案：
- leaderelecator
如果使用 leaderelecator 则对于一个 ip 相应有一个 lease，但是
- memberlist
获取 memberlist 的 watch 事件，之后进行处理


## 7. 额外的开发工作：
- helm chart - helm 卸载 keepalived 仍然在
- helm chart 迁移到主仓库
- 测试 - deploy securityContext  cri-o runtime 启动不了的解决办法
- 日志等级 + 日志格式
- 是否支持多租户？

## 8. e2e测试 
speaker - test
- ExternalTrafficPolicy - forward to loacl node
- nexthop should change when endpoint changed
- Nexthops should not be all nodes
- 多个网卡
- 升级方案 - helm






